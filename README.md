# Sap-sftp 定时任务实现文本推送的实例

标签（空格分隔）： elasticsearch quartz springBoot

---
目录

[TOC]

##背景描述
sftp的方式推送成功单，防骚扰转译后的话者分离文本，在合作伙伴区申请一台虚拟机用于部署LINUX系统及VSFTP服务端，同时在该虚拟上挂载NAS存储，直接将文本通过虚拟机的SFTP方式推到NAS存储，拟定质检区（观澜192.169.51.3）机器与合作伙伴区的虚拟机相连，防火墙由科技侧打通。

##详细设计
采用SpringBoot搭建的Maven轻应用架构方案，启动可配置化的定时任务，在空闲的时间推送话者分离文本。

###启动
- 启动命令（/home/mhn/）：nohup java -jar sap-sftp-1.0.jar &
> SapApplication为整个程序的入口

- 关闭 ps -ef|grep sap-sftp
> kill -9 +pid

- h2数据库由于是与项目集成的，和项目的生命周期保持一致，同生共死。
  h2数据库的访问，是在10.137.87.153机器上做了nginx跳转，地址为：
  http://10.137.87.153:7902/h2-console
  登录密码为：123456
附上图片说明：

- 小程序主要是通过设置的定时任务启动，执行的job分别为SuccessVoiveJob,FsrVoiceJob,CurrentVoiceJob,SuccessHistoryJob,FsrHistoryJob，分别对应于成功单录音文本推送，防骚扰录音文本推送，实时录音文本推送，历史成功单文本推送，历史防骚扰文本推送

> 附上schema.sql和data.sql

```sql
#schema.sql脚本
drop table config if exists;
create table config(
    id bigint generated by default as identity,
    cron varchar(40),
    primary key(id)
);

```
```sql
#data.sql脚本
#成功单定时任务时间
insert into config(id,cron) values(1,'0 30 0 * * ?');
#防骚扰定时任务时间
insert into config(id,cron) values(2,'0 30 0 * * ?');
#实时定时任务时间
insert into config(id,cron) values(3,'0 30 0 * * ?');
#防骚扰历史提前天数
insert into config(id,cron) values(4,'80');
#防骚扰历史开始时间（默认会包括这一天）
insert into config(id,cron) values(5,'2017-09-24 00:00:00');
#防骚扰历史任务开启on，关闭off
insert into config(id,cron) values(6,'on');
#防骚扰历史定时任务开始时间
insert into config(id,cron) values(7,'0 30 22 * * ?');
#成功单历史提前天数
insert into config(id,cron) values(8,'365');
#成功单历史开始时间（默认会包括这一天） 
insert into config(id,cron) values(9,'2017-09-24 00:00:00');
#成功单历史任务开启on，关闭off
insert into config(id,cron) values(10,'on');
#成功单历史定时任务开始时间
insert into config(id,cron) values(11,'0 30 22 * * ?');

```

###日志记录
`/home/mhn/nohup.out`
`/home/mhn/spring.log` 一共个数为7个，每一个11M，新生成的日志覆盖旧日志

###录音文件位置
以成功单录音文件为例进行说明：

- 1.本地单个文件位置
/home/mhn/voiceftp/success/2017/09/1/unzip/20170901_success_1_0/201709011938_hwc2a6723d20170901t1919372m0v3@U:.txt


- 2.本地推送文件以及压缩包位置
/home/mhn/voiceftp/success/2017/09/1/zip/20170901_success_1_0.txt 记录了201709011938_hwc2a6723d20170901t1919372m0v3@U:.txt文件名，可以多个
/home/mhn/voiceftp/success/2017/09/1/zip/20170901_success_1_0.zip


- 3.远程文件夹
在观澜机器（`192.169.51.3`）上登录，ssh 172.16.44.40  22端口
远程成功单文本位置
/nfsc/gcc_wer_id364676_fvol1001_prd/SpeechAnalytics/sinovoice/text/success/2017/09/1/20170901_success_1_0.txt
/nfsc/gcc_wer_id364676_fvol1001_prd/SpeechAnalytics/sinovoice/text/success/2017/09/1/20170901_success_1_0.zip

###配置化参数说明
```
application.properties的配置说明
# 服务器端口号,指定项目的端口和数据库的端口
#server.port=7902
server.port=7902  
# 是否生成ddl语句
spring.jpa.generate-ddl=false    
# 是否打印sql语句
spring.jpa.show-sql=true    
# 自动生成ddl，由于指定了具体的ddl，此处设置为none
spring.jpa.hibernate.ddl-auto=none    
# 使用H2数据库
spring.datasource.platform=h2
#配置数据库连接地址
spring.datasource.url=jdbc:h2:mem:config
#配置数据库驱动
spring.datasource.driver-class-name=org.h2.Driver
#配置数据库用户名
spring.datasource.username=root
#配置数据库密码
spring.datasource.password=123456
#配置能远程访问
spring.h2.console.settings.web-allow-others=true
#配置访问地址 localhost:8080/h2-console
spring.h2.console.path=/h2-console
#配置项目启动 h2就启动
spring.h2.console.enabled=true
# 指定生成数据库的schema文件位置
spring.datasource.schema=classpath:schema.sql    
# 指定插入数据库语句的脚本位置
spring.datasource.data=classpath:data.sql  

# 配置日志打印信息
logging.level.root=INFO    
#控制org.springframework包下的日志级别为DEBUG以上
logging.level.org.springframework=INFO
logging.level.org.hibernate=DEBUG    
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE    
logging.level.org.hibernate.type.descriptor.sql.BasicExtractor=TRACE    
logging.level.com.hcicloud.sap=DEBUG   
logging.file=spring.log

```




有问题欢迎咨询邮箱[^footnote1]

[^footnote1]: 707093428@qq.com





